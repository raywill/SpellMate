# 结尾不循环功能测试

## 功能说明

优化了播放控制逻辑，确保：
1. 播放到结尾后，继续说"下一个"会播放提示音，**不会循环回到开头**
2. 在结尾状态，说"上一个"可以回到最后一个片段
3. 在开头状态，说"上一个"会播放提示音，**不会跳到结尾**
4. 在开头或结尾状态，继续说相同方向的命令，会持续播放提示音

## 逻辑说明

### 状态标记

使用 `lastManualClickIndex` 来标记当前位置：
- `-1`: 初始状态或开头之前
- `0 ~ segments.length-1`: 具体片段的索引
- `segments.length`: 结尾之后（超出最后一个片段）

### 播放"下一个"逻辑

```
nextIndex = lastManualClickIndex + 1

如果 nextIndex >= segments.length:
    播放提示音
    设置 lastManualClickIndex = segments.length（保持在结尾状态）
否则:
    播放 nextIndex 对应的片段
    设置 lastManualClickIndex = nextIndex
```

### 播放"上一个"逻辑

```
prevIndex = lastManualClickIndex - 1

如果 prevIndex < 0:
    播放提示音
    不修改 lastManualClickIndex（保持在当前位置）
否则:
    播放 prevIndex 对应的片段
    设置 lastManualClickIndex = prevIndex
```

## 测试用例

### 测试用例 1: 播放到结尾不循环

**假设**: 有5个片段（索引0-4）

**步骤:**
1. 说"下一个" → 播放片段1（索引0）
2. 说"下一个" → 播放片段2（索引1）
3. 说"下一个" → 播放片段3（索引2）
4. 说"下一个" → 播放片段4（索引3）
5. 说"下一个" → 播放片段5（索引4）
6. 说"下一个" → **播放提示音** ✅
7. 再说"下一个" → **播放提示音**（不循环到片段1）✅
8. 继续说"下一个" → **播放提示音** ✅

**验证:**
- ✅ 第6步及之后都播放提示音
- ✅ 不会回到片段1
- ✅ 控制台显示提示音播放

### 测试用例 2: 从结尾回退

**接上一测试，当前在结尾状态**

**步骤:**
1. 说"上一个" → 播放片段5（索引4）✅
2. 说"上一个" → 播放片段4（索引3）✅
3. 说"下一个" → 播放片段5（索引4）✅
4. 说"下一个" → 播放提示音（到达结尾）✅

**验证:**
- ✅ 可以从结尾状态回退到最后一个片段
- ✅ 回退后可以正常前进

### 测试用例 3: 开头不能再往前

**假设**: 有5个片段，初始状态

**步骤:**
1. 说"上一个" → **播放提示音**（已经是开头）✅
2. 再说"上一个" → **播放提示音** ✅
3. 说"下一个" → 播放片段1（索引0）✅

**验证:**
- ✅ 在开头说"上一个"播放提示音
- ✅ 不会跳到结尾
- ✅ 之后说"下一个"从头开始

### 测试用例 4: 第一个片段往前

**步骤:**
1. 说"下一个" → 播放片段1（索引0）
2. 说"上一个" → **播放提示音** ✅
3. 说"上一个" → **播放提示音** ✅
4. 说"下一个" → 播放片段2（索引1）✅

**验证:**
- ✅ 在第一个片段说"上一个"播放提示音
- ✅ 位置保持在片段1
- ✅ 之后说"下一个"播放片段2（不是片段1）

### 测试用例 5: 手动点击打破状态

**步骤:**
1. 播放到结尾（说5次"下一个"）
2. 说"下一个" → 播放提示音（在结尾状态）
3. 手动点击片段3（索引2）
4. 说"下一个" → 播放片段4（索引3）✅
5. 说"下一个" → 播放片段5（索引4）✅
6. 说"下一个" → 播放提示音（重新到达结尾）✅

**验证:**
- ✅ 手动点击可以打破结尾状态
- ✅ 从手动点击的位置继续播放

### 测试用例 6: 重播不影响位置

**步骤:**
1. 说"下一个" → 播放片段1（索引0）
2. 说"下一个" → 播放片段2（索引1）
3. 说"重播" → 重播片段2（索引1）✅
4. 说"下一个" → 播放片段3（索引2）✅
5. 说"上一个" → 播放片段2（索引1）✅

**验证:**
- ✅ "重播"不改变当前位置
- ✅ 重播后可以正常前进和后退

### 测试用例 7: 连续播放到结尾

**步骤:**
1. 连续说10次"下一个"（假设只有5个片段）
   - 前5次播放片段1-5
   - 后5次都播放提示音 ✅

**验证:**
- ✅ 所有超出范围的"下一个"都播放提示音
- ✅ 不会循环

### 测试用例 8: 完整场景测试

**步骤:**
1. 说"上一个" → 提示音（开头）
2. 说"下一个" → 片段1
3. 说"下一个" → 片段2
4. 说"上一个" → 片段1
5. 说"上一个" → 提示音（开头）
6. 说"下一个" → 片段2（从片段1的下一个）
7. 说"下一个" → 片段3
8. 说"下一个" → 片段4
9. 说"下一个" → 片段5
10. 说"下一个" → 提示音（结尾）
11. 说"上一个" → 片段5
12. 说"下一个" → 提示音（结尾）

**验证:**
- ✅ 整个流程逻辑正确
- ✅ 边界处理正确

## 状态转换图

```
初始状态 (-1)
   |
   | 说"下一个"
   ↓
片段1 (0)
   |
   | 说"下一个"
   ↓
片段2 (1)
   |
   | ...
   ↓
片段5 (4)
   |
   | 说"下一个"
   ↓
结尾状态 (5)
   |
   | 说"下一个" → 提示音（保持在5）
   | 说"上一个" → 回到片段5
```

## 提示音说明

### 提示音播放场景
1. 在开头状态（初始或片段1），说"上一个"
2. 在结尾状态（超出最后片段），说"下一个"

### 提示音特性
- 440Hz 正弦波
- 持续 0.3 秒
- 音量淡出效果

## 与旧版本的对比

### 旧版本（有问题）
```
到达结尾后:
    播放提示音
    重置 lastManualClickIndex = -1  ← 问题所在
    
下次说"下一个":
    nextIndex = -1 + 1 = 0
    播放片段1（循环回到开头）  ← 不符合预期
```

### 新版本（已修复）
```
到达结尾后:
    播放提示音
    设置 lastManualClickIndex = segments.length  ← 保持结尾状态
    
下次说"下一个":
    nextIndex = segments.length + 1
    还是 >= segments.length
    继续播放提示音  ← 符合预期
```

## 调试方法

在浏览器控制台中查看当前状态：

```javascript
// 查看当前位置索引
recorder.lastManualClickIndex

// 查看片段总数
recorder.segments.length

// 手动设置位置（用于测试）
recorder.lastManualClickIndex = 4  // 设置为第5个片段
recorder.lastManualClickIndex = 5  // 设置为结尾状态
recorder.lastManualClickIndex = -1 // 设置为开头状态
```

## 常见问题

### Q1: 为什么到结尾后不自动循环？
**A**: 这是设计选择。在听写场景中，完成所有片段后，用户可能需要确认是否真的完成了，而不是意外地又从头开始。如果需要重新开始，可以手动点击第一个片段。

### Q2: 如何重新开始播放？
**A**: 三种方法：
1. 手动点击第一个片段的"播放"按钮
2. 在结尾状态，依次说"上一个"回到开头
3. 刷新页面（如果有保存的数据会自动恢复）

### Q3: 提示音能自定义吗？
**A**: 目前使用440Hz正弦波。如果需要自定义，可以修改 `playCompletionSound()` 方法中的 `oscillator.frequency.value` 和持续时间。

## 测试完成检查清单

- [ ] 播放到结尾，继续说"下一个"播放提示音（不循环）
- [ ] 在结尾状态，说"上一个"回到最后一个片段
- [ ] 在开头状态，说"上一个"播放提示音（不跳到结尾）
- [ ] 在第一个片段，说"上一个"播放提示音，位置不变
- [ ] 在第一个片段播放提示音后，说"下一个"播放第二个片段
- [ ] 手动点击可以打破结尾/开头状态
- [ ] "重播"不改变当前位置
- [ ] 连续说多次"下一个"在结尾都播放提示音

## 总结

优化后的逻辑更加合理：
- ✅ 不会意外循环，避免用户困惑
- ✅ 提供明确的开头/结尾反馈（提示音）
- ✅ 支持从结尾回退到任意位置
- ✅ 手动点击可以随时改变位置
- ✅ 逻辑清晰，易于理解和维护

