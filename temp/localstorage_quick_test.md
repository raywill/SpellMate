# localStorage 持久化 - 3分钟快速测试

## 测试准备
确保使用 Chrome 或 Edge 浏览器，并打开开发者工具（F12）查看控制台输出。

## 测试步骤

### 第1步: 录制并保存（30秒）
1. 打开 index.html
2. 点击"开始录制"
3. 说："苹果" [停顿1秒] "香蕉" [停顿1秒] "橘子"
4. 点击"结束录制"
5. **验证**: 
   - ✅ 看到3个片段
   - ✅ 控制台显示："数据已保存到 localStorage"
   - ✅ 状态显示："✅ 录音完成,已分割为 3 个片段"

### 第2步: 刷新恢复（10秒）
1. 刷新页面（F5 或 Cmd+R）
2. **验证**:
   - ✅ 控制台显示："从 localStorage 加载数据..."
   - ✅ 控制台显示："数据恢复成功"
   - ✅ 自动显示3个片段（苹果、香蕉、橘子）
   - ✅ 状态显示："✅ 已恢复 3 个片段（2025-11-5 XX:XX:XX）"
   - ✅ 语音控制区域自动显示

### 第3步: 测试播放（30秒）
1. 点击第1个片段的"播放"按钮
2. **验证**:
   - ✅ 听到"苹果"播放两次，中间停顿0.3秒
   - ✅ 进度条正常显示
3. 开启语音控制，说"下一个"
4. **验证**:
   - ✅ 听到"香蕉"播放两次
   - ✅ 语音控制功能正常

### 第4步: 清理测试（30秒）
1. 点击"开始录制"（不要实际录音）
2. **验证**:
   - ✅ 控制台显示："localStorage 已清理"
   - ✅ 片段列表被清空
   - ✅ 语音控制区域隐藏
3. 关闭麦克风权限对话框
4. 刷新页面
5. **验证**:
   - ✅ 控制台显示："没有找到保存的数据"
   - ✅ 显示初始状态："准备就绪"

### 第5步: 多次录制（1分钟）
1. 录制第一段："红色" [停顿] "绿色"
2. 刷新页面，验证显示2个片段
3. 点击"开始录制"
4. 录制第二段："猫" [停顿] "狗" [停顿] "鸟"
5. 刷新页面
6. **验证**:
   - ✅ 只显示3个片段（猫、狗、鸟）
   - ✅ 之前的"红色、绿色"已被清除

## 查看存储数据（可选）

1. 按 F12 打开开发者工具
2. 进入 **Application** 标签（Chrome）或 **Storage** 标签（Firefox）
3. 左侧选择 **Local Storage** → **file://**
4. 找到 `voiceRecorderData` 项
5. 可以看到存储的 JSON 数据，包含：
   - `audioData`: base64 编码的音频数据
   - `timestamp`: 录制时间戳
   - `segmentCount`: 片段数量
   - `silenceThreshold`: 停顿阈值
   - `volumeThreshold`: 音量阈值

## 测试结果检查清单

- [ ] 录制后控制台显示"数据已保存"
- [ ] 刷新后自动恢复片段
- [ ] 恢复后的片段可以正常播放
- [ ] 连播两次功能正常
- [ ] 语音控制可以开启并正常工作
- [ ] 点击"开始录制"清理旧数据
- [ ] 多次录制只保留最新数据
- [ ] localStorage 中可以看到 voiceRecorderData
- [ ] 参数设置（停顿阈值、音量阈值）也被恢复

## 常见问题

### Q1: 刷新后数据没有恢复？
**A**: 
- 检查控制台是否有错误
- 确认录制后有"数据已保存"提示
- 查看 Application → Local Storage 中是否有数据

### Q2: 提示"存储空间不足"？
**A**:
- 录音时间过长（建议<2分钟）
- localStorage 已满，清理浏览器缓存
- 尝试录制更短的内容

### Q3: 数据恢复后无法播放？
**A**:
- 检查控制台错误信息
- 可能是数据损坏，点击"开始录制"清理后重新录制
- 确保使用 Chrome 或 Edge 浏览器

### Q4: 关闭浏览器后数据丢失？
**A**:
- 确认不是使用无痕/隐私模式
- 无痕模式下 localStorage 会在关闭后清除
- 使用正常模式打开网页

## 技术说明

### 存储内容
```json
{
  "audioData": "data:audio/webm;base64,GkXf...",
  "timestamp": 1699164645000,
  "segmentCount": 3,
  "silenceThreshold": 1.0,
  "volumeThreshold": 0.01
}
```

### 存储大小估算
- 1分钟录音: 约 1-1.5 MB
- 2分钟录音: 约 2-3 MB
- localStorage 限制: 5-10 MB（因浏览器而异）

### 保存时机
- 录制完成并分段成功后自动保存
- 每次保存会覆盖之前的数据

### 加载时机
- 页面加载时自动检查并恢复
- 如果数据损坏会自动清理

### 清理时机
- 点击"开始录制"时自动清理
- 数据损坏时自动清理
- 可以手动在控制台执行: `localStorage.removeItem('voiceRecorderData')`

## 高级测试（可选）

### 测试数据损坏恢复
1. 录制并保存数据
2. 在 Application → Local Storage 中手动编辑 `voiceRecorderData`
3. 删除部分内容使其成为无效 JSON
4. 刷新页面
5. **验证**: 控制台显示错误，自动清理数据，页面恢复初始状态

### 测试跨会话持久化
1. 录制并保存数据
2. 完全关闭浏览器（不只是标签页）
3. 重新打开浏览器
4. 打开 index.html
5. **验证**: 数据依然恢复

### 测试大容量录音
1. 录制3分钟以上的内容
2. 如果保存失败，会弹出"存储空间不足"提示
3. 验证应用不会崩溃，可以继续使用

## 测试完成！

如果所有测试都通过，说明 localStorage 持久化功能工作正常。

遇到问题？查看完整测试文档：`temp/localstorage_test.md`

