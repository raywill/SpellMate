# localStorage 持久化功能测试

## 功能说明

应用现在支持将录制的音频数据保存到浏览器的 localStorage 中，即使刷新页面或关闭浏览器，数据也不会丢失。

## 保存内容

- 录制的音频数据（base64 格式）
- 录制时间戳
- 片段数量
- 停顿阈值设置
- 音量阈值设置

## 测试用例

### 测试用例 1: 基础保存和恢复

**步骤:**
1. 打开 index.html
2. 录制一段话（例如："苹果 香蕉 橘子"）
3. 结束录制，等待自动分段
4. **观察**: 控制台应该显示"数据已保存到 localStorage"
5. 刷新页面（F5 或 Cmd+R）
6. **验证**: 
   - 自动恢复之前的片段
   - 状态显示"已恢复 X 个片段（录制时间）"
   - 语音控制区域自动显示
   - 所有片段都可以正常播放

### 测试用例 2: 参数设置恢复

**步骤:**
1. 录制前调整参数：
   - 停顿阈值改为 1.5 秒
   - 音量阈值改为 0.015
2. 录制并分段
3. 刷新页面
4. **验证**:
   - 停顿阈值显示为 1.5 秒
   - 音量阈值显示为 0.015
   - 滑块位置正确

### 测试用例 3: 开始录制时清理数据

**步骤:**
1. 确保有已保存的数据（录制过一次）
2. 刷新页面，验证数据已恢复
3. 点击"开始录制"按钮
4. **验证**:
   - 控制台显示"localStorage 已清理"
   - 之前的片段列表被清空
   - 语音控制区域隐藏
   - 状态显示"正在录音..."
5. 结束录制
6. 刷新页面
7. **验证**: 只恢复最新录制的内容，之前的已被清除

### 测试用例 4: 多次录制覆盖

**步骤:**
1. 录制第一段话："红色 绿色 蓝色"
2. 刷新页面，验证恢复了3个片段
3. 点击"开始录制"
4. 录制第二段话："猫 狗 鸟"
5. 刷新页面
6. **验证**: 只有第二次录制的3个片段（猫、狗、鸟）

### 测试用例 5: 跨会话持久化

**步骤:**
1. 录制一段话
2. **完全关闭浏览器**（不只是关闭标签页）
3. 重新打开浏览器
4. 打开 index.html
5. **验证**: 
   - 数据依然恢复
   - 所有功能正常工作

### 测试用例 6: 语音控制状态恢复

**步骤:**
1. 录制并生成片段
2. 开启语音控制
3. 播放几个片段
4. 刷新页面
5. **验证**:
   - 片段恢复
   - 语音控制按钮显示但处于关闭状态
   - 可以重新开启语音控制
   - 语音控制功能正常

### 测试用例 7: 大数据量测试

**步骤:**
1. 录制一段较长的话（20+个词）
2. 等待自动分段
3. **验证**: 
   - 保存成功（如果失败会弹出"存储空间不足"提示）
   - 刷新后能够完整恢复
   - 控制台显示保存的数据大小

### 测试用例 8: 数据损坏处理

**步骤:**
1. 录制并保存数据
2. 打开浏览器开发者工具（F12）
3. 进入 Application/Storage → Local Storage
4. 找到 `voiceRecorderData` 项
5. 手动修改其值为无效数据（如删除一部分）
6. 刷新页面
7. **验证**:
   - 控制台显示"从 localStorage 加载失败"
   - 自动清理损坏的数据
   - 页面显示初始状态，可以重新录制

### 测试用例 9: 清理数据按钮

**步骤:**
1. 录制数据
2. 刷新页面验证数据存在
3. 点击"开始录制"（不要实际录制，直接关闭麦克风权限对话框）
4. **验证**: localStorage 已被清理，刷新后不再有数据

### 测试用例 10: 播放功能与持久化

**步骤:**
1. 录制5个词
2. 手动点击第3个片段播放
3. 使用语音命令"下一个"播放第4个
4. 刷新页面
5. **验证**:
   - 所有片段都能正常播放
   - 连播两次功能正常
   - 语音控制可以重新开启并正常工作

## 控制台输出示例

### 保存数据时
```
数据已保存到 localStorage
```

### 加载数据时
```
从 localStorage 加载数据... {
  timestamp: Tue Nov 05 2025 10:30:45 GMT+0800,
  segmentCount: 5
}
数据恢复成功
```

### 清理数据时
```
localStorage 已清理
```

### 加载失败时
```
从 localStorage 加载失败: SyntaxError: ...
localStorage 已清理
```

## 存储限制

- **localStorage 容量**: 通常为 5-10MB（因浏览器而异）
- **单个音频大小**: 建议不超过 2-3MB
- **录制时长**: 建议单次录制不超过 2 分钟
- **片段数量**: 无限制，但总数据大小受限

## 查看存储数据

### Chrome/Edge
1. 按 F12 打开开发者工具
2. 进入 Application 标签
3. 左侧选择 Storage → Local Storage → file://
4. 找到 `voiceRecorderData` 项
5. 可以看到存储的 JSON 数据

### Firefox
1. 按 F12 打开开发者工具
2. 进入 Storage 标签
3. 选择 Local Storage → file://
4. 找到 `voiceRecorderData` 项

### Safari
1. 开启开发菜单（偏好设置 → 高级 → 显示开发菜单）
2. 开发 → 显示网页检查器
3. 存储标签 → 本地存储

## 手动清理数据

如果需要手动清理存储的数据：

### 方法1: 通过代码
在浏览器控制台执行：
```javascript
localStorage.removeItem('voiceRecorderData');
```

### 方法2: 通过应用
点击"开始录制"按钮，数据会被自动清理

### 方法3: 通过浏览器
在开发者工具的 Storage 面板中，右键点击 `voiceRecorderData` → Delete

## 已知限制

1. **跨设备不同步**: localStorage 只在当前浏览器、当前设备上存储
2. **隐私模式**: 无痕/隐私模式下，localStorage 在关闭窗口后会被清除
3. **容量限制**: 超过浏览器限制时会弹出提示，无法保存
4. **域名绑定**: file:// 协议的数据不能跨文件共享

## 性能测试

### 保存速度
- 1分钟录音（约1MB）: < 500ms
- 2分钟录音（约2MB）: < 1000ms

### 加载速度
- 1分钟录音: < 300ms
- 2分钟录音: < 600ms

## 故障排查

### 问题: 刷新后数据没有恢复
- **检查**: 控制台是否有错误
- **检查**: localStorage 中是否有 `voiceRecorderData`
- **解决**: 清理 localStorage 后重新录制

### 问题: 保存时提示"存储空间不足"
- **原因**: localStorage 已满或录音文件过大
- **解决**: 
  1. 清理浏览器缓存
  2. 录制更短的内容
  3. 清理其他网站的 localStorage

### 问题: 加载时出错
- **原因**: 数据损坏或格式不兼容
- **解决**: 应用会自动清理损坏数据，可以重新录制

## 最佳实践

1. **定期清理**: 不需要的录音及时清理，避免占用空间
2. **短时录制**: 建议单次录制时长在1-2分钟内
3. **及时保存**: 录制完成后确认"数据已保存"提示
4. **备份重要数据**: localStorage 可能被清理，重要内容请另行保存

## 测试结果记录

| 测试用例 | 预期结果 | 实际结果 | 通过 |
|---------|---------|---------|-----|
| 用例1 基础保存恢复 | 刷新后自动恢复 | | ☐ |
| 用例2 参数恢复 | 参数正确恢复 | | ☐ |
| 用例3 录制时清理 | 自动清理旧数据 | | ☐ |
| 用例4 多次覆盖 | 只保留最新数据 | | ☐ |
| 用例5 跨会话 | 关闭浏览器后恢复 | | ☐ |
| 用例6 语音控制 | 功能正常恢复 | | ☐ |
| 用例7 大数据量 | 正常保存或提示 | | ☐ |
| 用例8 数据损坏 | 自动清理恢复 | | ☐ |
| 用例9 清理按钮 | 数据被清理 | | ☐ |
| 用例10 播放功能 | 播放功能正常 | | ☐ |

