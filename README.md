# 语音听写助手

一个基于Web Audio API和语音识别的智能听写工具，专为家长录制、孩子听写场景设计。

## 功能特性

- 🎙️ **录音功能**: 支持通过浏览器录制音频
- 🎵 **实时波形**: 录制时显示实时音频波形动画,有声音时跳动,静音时平直
- ✂️ **智能分段**: 自动根据停顿(静音)将录音分割成多个片段
- 🎤 **语音控制**: 使用语音命令控制播放（下一个、重播、上一个）
- 🔁 **连播两次**: 每个片段自动播放两次，中间停顿0.5秒
- 🎯 **智能追踪**: 记住手动点击位置，语音命令从该位置继续
- 💾 **数据持久化**: 自动保存到 localStorage，刷新页面不丢失
- 🌍 **多语言支持**: 支持中文、英文、日语、法语、德语、西班牙语
- ▶️ **独立播放**: 每个片段可以单独播放
- ⚙️ **可调参数**: 支持调整停顿阈值和音量阈值
- 🎨 **现代UI**: 美观的渐变背景和交互设计
- 📊 **播放进度**: 实时显示播放进度条
- 🔔 **提示音**: 播放完毕或无效操作时播放提示音
- 🚫 **微信检测**: 自动检测微信浏览器并提示在系统浏览器中打开

## 文件说明

- `index.html` - 主应用页面
- `i18n.js` - 多语言配置文件
- `favicon-128.ico` - 应用图标（彩色铅笔）
- `manifest.json` - PWA配置文件
- `README.md` - 使用说明
- `temp/` - 测试文档目录

## 多语言支持

应用支持以下语言，可在"高级设置"中切换：
- 🇨🇳 中文 (Chinese)
- 🇺🇸 英语 (English) 
- 🇯🇵 日语 (Japanese)
- 🇫🇷 法语 (French)
- 🇩🇪 德语 (German)
- 🇪🇸 西班牙语 (Spanish)

**自动检测**: 首次打开时根据浏览器语言自动设置界面语言
**手动切换**: 在高级设置中点击国旗按钮即可切换语言
**持久化**: 选择的语言会自动保存，下次打开保持设置

## 使用方法

### 场景1: 家长录制听写内容

1. 在浏览器中打开 `index.html` 文件
2. 点击"开始录制"按钮开始录音
3. 录制时会出现实时音频波形显示,可以观察到:
   - 有声音输入时,波形上下跳动
   - 静音时,波形接近平直的中线
4. 说出要听写的词语或短语，每个之间停顿1秒以上
   - 例如："苹果" [停顿] "香蕉" [停顿] "橘子" [停顿] "西瓜"
5. 点击"结束录制"按钮停止录音
6. 系统会自动分析并分割录音为多个片段

### 场景2: 孩子使用语音控制听写

1. 录制完成后，点击"开启语音控制"按钮
2. 说出语音命令来控制播放:
   - **"下一个"** 或 **"好的"** 或 **"写好了"** → 播放下一个片段
   - **"重播"** 或 **"再说一遍"** 或 **"什么"** → 重新播放当前片段
   - **"上一个"** 或 **"回退"** → 播放上一个片段
3. 每个片段会自动连续播放两次，中间停顿0.3秒
4. 听完后写下听到的词语，然后说"下一个"继续
5. 如果没听清，说"再说一遍"重新播放
6. 也可以手动点击任意片段的"播放"按钮

### 数据持久化说明

- ✅ **自动保存**: 录制完成后，音频数据会自动保存到浏览器 localStorage
- ✅ **自动恢复**: 刷新页面或重新打开时，会自动恢复之前的录音
- ✅ **进度记忆**: 播放进度会实时保存，下次打开从上次位置继续
- ✅ **参数记忆**: 停顿阈值、音量阈值等设置也会被保存
- ✅ **录制清理**: 点击"开始录制"时会自动清理之前的数据，开始新的录制
- ⚠️ **存储限制**: localStorage 通常为 5-10MB，建议单次录制不超过 2 分钟
- ⚠️ **本地存储**: 数据只保存在当前浏览器，不会跨设备同步

**典型使用场景**:
1. 妈妈晚上录制好第二天的听写内容
2. 第二天孩子打开网页，录音自动恢复
3. 孩子开始听写，完成了3个词后暂停
4. 下次打开页面，自动恢复到第3个词的位置，可以继续听写
5. 录制新内容时，旧数据自动清理

## 语音命令列表

### 播放下一个片段
下一个、下一题、好的、写好了、继续、下一句、对了、好了、完成、知道了、好、ok

### 重新播放当前片段（或从头开始听写）
开始、重播、再说一遍、再来一次、什么、没听清、再听、听不清、重复、重来

### 播放上一个片段
上一个、上一题、回退、返回、上一句、前一个

## 参数调整

- **停顿阈值**: 设置多少秒的静音被视为片段分隔(默认1.0秒)
- **音量阈值**: 设置音量低于多少被视为静音(默认0.010,用于容忍白噪声)

## 技术实现

- 使用 `MediaRecorder API` 进行录音
- 使用 `Web Audio API` 分析和处理音频
- 使用 `SpeechRecognition API` 进行语音命令识别
- 通过音量检测算法识别停顿
- 实时计算20ms窗口的平均音量
- 过滤掉小于0.2秒的片段
- 智能播放队列管理（连播两次，停顿0.3秒）
- 提示音生成（440Hz正弦波）
- 片段前后添加0.1秒缓冲，声音更自然

## 浏览器兼容性

需要支持以下API的现代浏览器:
- MediaRecorder API
- Web Audio API
- getUserMedia API
- SpeechRecognition API（语音控制功能）

推荐使用:
- **Chrome 60+**（推荐，完整支持所有功能）
- **Edge 79+**（完整支持）
- Safari 14.1+（部分支持语音识别）
- Firefox 55+（不支持语音识别）

**注意**: 语音识别功能需要 Chrome/Edge 浏览器，其他功能在所有现代浏览器中都可用。

## 重要提示

### 🚫 不支持微信浏览器

由于微信内置浏览器限制了麦克风权限，**无法在微信中使用本应用**。

如果在微信中打开，应用会自动显示提示页面，引导用户：
1. 点击右上角 **···** 菜单
2. 选择 **在浏览器中打开**

请使用以下浏览器：
- ✅ Chrome（推荐）
- ✅ Safari
- ✅ Edge
- ✅ Firefox（语音控制功能除外）

## 添加到主屏幕

### 📱 iOS (iPhone/iPad)
1. 在 Safari 中打开应用
2. 点击底部 **分享按钮** (⬆️)
3. 选择 **"添加到主屏幕"**
4. 点击 **"添加"**

添加后，应用会以独立模式运行，显示铅笔图标。

### 🤖 Android
1. 在 Chrome 中打开应用
2. 点击右上角菜单 (⋮)
3. 选择 **"添加到主屏幕"** 或 **"安装"**
4. 点击 **"添加"**

添加后，可以像原生应用一样使用。

**注意**: 如果图标不显示，可能需要清除浏览器缓存或使用HTTPS部署。

## 测试方法

### 基础功能测试
1. 确保浏览器允许麦克风权限
2. 开始录制,说几个词,每个词之间停顿1秒以上
   - 例如："苹果" [停顿] "香蕉" [停顿] "橘子"
3. 结束录制,检查是否正确分段
4. 点击任意片段的"播放"按钮
5. 验证片段是否连续播放两次，中间停顿0.3秒

### 语音控制测试
1. 录制完成后，点击"开启语音控制"
2. 说"下一个"，验证是否播放第一个片段
3. 说"下一个"，验证是否播放第二个片段
4. 说"重播"，验证是否重新播放第二个片段
5. 说"上一个"，验证是否播放第一个片段
6. 手动点击第三个片段
7. 说"下一个"，验证是否播放第四个片段（从点击位置继续）

### 数据持久化测试
1. 录制一段话，等待自动分段
2. 刷新页面（F5）
3. 验证片段自动恢复，显示"已恢复 X 个片段"
4. 验证所有片段可以正常播放
5. 点击"开始录制"，验证旧数据被清理
6. 录制新内容，刷新后验证只有新数据

详细测试用例请查看:
- `temp/voice_control_test.md` - 语音控制测试
- `temp/localstorage_test.md` - 数据持久化测试

